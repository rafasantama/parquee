/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output, Renderer2, ChangeDetectionStrategy, } from '@angular/core';
import imagesLoadedMethod from 'imagesloaded';
import * as masonry from 'masonry-layout';
import { utilities } from './utilities';
var MasonryGalleryComponent = /** @class */ (function () {
    function MasonryGalleryComponent(renderer) {
        this.renderer = renderer;
        this.images = [];
        this.width = 330;
        this.gutter = 5;
        this.verticalGutter = 5;
        this.imageClasses = [];
        this.clickImage = new EventEmitter();
        this.removeComplete = new EventEmitter();
        this.layoutComplete = new EventEmitter();
        this.galleryGuid = utilities.newGuid();
        this.mansonryItemSelectorClass = "grid-item-" + this.galleryGuid;
        this.activeImages = [];
        this.viewReady = false;
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    MasonryGalleryComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if (changes.images && changes.images.currentValue) {
            if (!this.viewReady) {
                // process images once we can
                this.changesToProcess = changes;
            }
            else {
                this.processImages(changes);
            }
        }
    };
    /**
     * @return {?}
     */
    MasonryGalleryComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.msnry) {
            this.msnry.destroy();
        }
    };
    /**
     * @param {?} image
     * @return {?}
     */
    MasonryGalleryComponent.prototype.handleClick = /**
     * @param {?} image
     * @return {?}
     */
    function (image) {
        this.clickImage.next(image);
    };
    /**
     * @return {?}
     */
    MasonryGalleryComponent.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this.viewReady = true;
        this.initMasonry();
        // process images now
        if (this.changesToProcess) {
            this.processImages(this.changesToProcess);
            this.changesToProcess = undefined;
        }
    };
    /**
     * @param {?} images
     * @return {?}
     */
    MasonryGalleryComponent.prototype.addImages = /**
     * @param {?} images
     * @return {?}
     */
    function (images) {
        if (images && images.length > 0) {
            this.addImagesToGallery(images);
        }
    };
    /**
     * @param {?} images
     * @return {?}
     */
    MasonryGalleryComponent.prototype.removeImages = /**
     * @param {?} images
     * @return {?}
     */
    function (images) {
        var _this = this;
        if (images && images.length > 0) {
            images.forEach((/**
             * @param {?} image
             * @return {?}
             */
            function (image) {
                _this.removeImageFromGallery(image);
            }));
        }
    };
    /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    MasonryGalleryComponent.prototype.processImages = /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        /** @type {?} */
        var imagesToProcess = this.getAddedAndRemovesImages(changes);
        // add images to mansonry layout
        this.addImages(imagesToProcess.addedImages);
        // removes images from layout
        this.removeImages(imagesToProcess.removedImages);
    };
    /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    MasonryGalleryComponent.prototype.getAddedAndRemovesImages = /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        /** @type {?} */
        var addedImages = [];
        /** @type {?} */
        var removedImages = [];
        /** @type {?} */
        var newImagesValue = (/** @type {?} */ (changes.images
            .currentValue));
        /** @type {?} */
        var oldImagesValue = (/** @type {?} */ (changes.images
            .previousValue));
        if (!oldImagesValue) {
            // all images are new ones
            addedImages = changes.images.currentValue;
        }
        else {
            // process added images
            newImagesValue.forEach((/**
             * @param {?} newImage
             * @return {?}
             */
            function (newImage) {
                /** @type {?} */
                var existingImage = oldImagesValue.find((/**
                 * @param {?} m
                 * @return {?}
                 */
                function (m) { return m.imageUrl.toLowerCase() === newImage.imageUrl.toLowerCase(); }));
                if (existingImage) {
                    // image was in previous value && is in new, do nothing
                }
                else {
                    // image is new
                    addedImages.push(newImage);
                }
            }));
            // process removed images
            oldImagesValue.forEach((/**
             * @param {?} oldImage
             * @return {?}
             */
            function (oldImage) {
                /** @type {?} */
                var existingImage = newImagesValue.find((/**
                 * @param {?} m
                 * @return {?}
                 */
                function (m) { return m.imageUrl.toLowerCase() === oldImage.imageUrl.toLowerCase(); }));
                if (existingImage) {
                    // image was in previous value && is in new, do nothing
                }
                else {
                    // image is removed
                    removedImages.push(oldImage);
                }
            }));
        }
        return {
            addedImages: addedImages,
            removedImages: removedImages
        };
    };
    /**
     * @private
     * @return {?}
     */
    MasonryGalleryComponent.prototype.initMasonry = /**
     * @private
     * @return {?}
     */
    function () {
        this.grid = document.getElementById(this.galleryGuid);
        // remove all existing data from grid
        this.grid.innerHTML = '';
        if (!this.grid) {
            throw Error("Could not init mansory due to non existing elem with id '" + this.galleryGuid + "'");
        }
        this.msnry = new masonry(this.grid, {
            // options...
            itemSelector: '.' + this.mansonryItemSelectorClass,
            columnWidth: this.width,
            gutter: this.gutter,
        });
        /** @type {?} */
        var that = this;
        this.msnry.on('layoutComplete', (/**
         * @param {?} items
         * @return {?}
         */
        function (items) {
            that.layoutComplete.next(items);
        }));
        this.msnry.on('removeComplete', (/**
         * @param {?} items
         * @return {?}
         */
        function (items) {
            that.removeComplete.next(items);
        }));
    };
    /**
     * @private
     * @param {?} image
     * @return {?}
     */
    MasonryGalleryComponent.prototype.removeImageFromGallery = /**
     * @private
     * @param {?} image
     * @return {?}
     */
    function (image) {
        // get image guid
        /** @type {?} */
        var imageIdResult = this.activeImages.find((/**
         * @param {?} m
         * @return {?}
         */
        function (m) { return m.image.imageUrl.toLowerCase() === image.imageUrl.toLowerCase(); }));
        if (!imageIdResult) {
            // image was not found, this is probably an error
            console.warn("Image with url '" + image.imageUrl + "' was not found. If you are adding images, make sure to 'replace' the images array with a new one\n                so that detection change can be executed instead of just adding an image to array\n                (which doesn't fire change detection on array property)");
            return;
        }
        // find image based on its id
        /** @type {?} */
        var imageElem = document.getElementById(imageIdResult.id);
        if (!imageElem) {
            // image was not found in DOM
            console.warn("Image with id '{" + imageIdResult.id + "}' was not found in DOM. Have you manipulated the DOM in some way?");
            return;
        }
        // remove image from gallery
        this.msnry.remove(imageElem);
        // refresh layout
        this.msnry.layout();
        // remove image from array
        for (var i = 0; i < this.activeImages.length; i++) {
            /** @type {?} */
            var idWithImage = this.activeImages[i];
            if (idWithImage.image.imageUrl.toLowerCase() ===
                imageIdResult.image.imageUrl.toLowerCase()) {
                this.activeImages.splice(i, 1);
            }
        }
    };
    /**
     * @private
     * @param {?} images
     * @return {?}
     */
    MasonryGalleryComponent.prototype.addImagesToGallery = /**
     * @private
     * @param {?} images
     * @return {?}
     */
    function (images) {
        var _this = this;
        if (!this.grid) {
            throw Error('Grid element is not yet ready, are you trying to add image too soon?');
        }
        /** @type {?} */
        var imagesWrapper = this.renderer.createElement('span');
        images.forEach((/**
         * @param {?} image
         * @return {?}
         */
        function (image) {
            // generate unique image id
            /** @type {?} */
            var imageId = _this.getImageId();
            // create element
            /** @type {?} */
            var imageElem = _this.renderer.createElement('img');
            imageElem.setAttribute('id', imageId);
            imageElem.setAttribute('alt', image.alt ? image.alt : 'no description');
            imageElem.setAttribute('src', image.imageUrl);
            // note - images are hidden by default and should be shown only after they are loaded
            imageElem.setAttribute('style', "display: none; width: " + _this.width + "px; margin-bottom: " + _this.verticalGutter + "px");
            imageElem.className = _this.getImageClass();
            imageElem.addEventListener('click', (/**
             * @return {?}
             */
            function () {
                _this.handleClick(image);
            }));
            // store guid with this image
            _this.activeImages.push({
                id: imageId,
                image: image
            });
            // add to dom and mansory & refresh layout
            _this.renderer.appendChild(imagesWrapper, imageElem);
        }));
        // add html to dom
        this.renderer.appendChild(this.grid, imagesWrapper);
        // add images once they are loaded
        /** @type {?} */
        var imgLoad = imagesLoadedMethod(imagesWrapper);
        imgLoad.on('progress', (/**
         * @param {?} instance
         * @param {?} image
         * @return {?}
         */
        function (instance, image) {
            if (image.isLoaded) {
                _this.renderer.appendChild(_this.grid, image.img);
                // unhide image
                _this.renderer.setStyle(image.img, 'display', 'block');
                _this.msnry.appended(image.img);
                _this.msnry.reloadItems();
            }
        }));
    };
    /**
     * @private
     * @return {?}
     */
    MasonryGalleryComponent.prototype.getImageClass = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var className = this.mansonryItemSelectorClass;
        if (this.imageClasses && this.imageClasses.length > 0) {
            /** @type {?} */
            var customClass = this.imageClasses.join(' ');
            className += ' ' + customClass;
        }
        return className;
    };
    /**
     * @private
     * @return {?}
     */
    MasonryGalleryComponent.prototype.getImageId = /**
     * @private
     * @return {?}
     */
    function () {
        return this.galleryGuid + '_' + utilities.newGuid();
    };
    MasonryGalleryComponent.decorators = [
        { type: Component, args: [{
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    selector: 'ngx-masonry-gallery',
                    template: '<div [id]="galleryGuid"></div>'
                }] }
    ];
    /** @nocollapse */
    MasonryGalleryComponent.ctorParameters = function () { return [
        { type: Renderer2 }
    ]; };
    MasonryGalleryComponent.propDecorators = {
        images: [{ type: Input }],
        width: [{ type: Input }],
        gutter: [{ type: Input }],
        verticalGutter: [{ type: Input }],
        imageClasses: [{ type: Input }],
        clickImage: [{ type: Output }],
        removeComplete: [{ type: Output }],
        layoutComplete: [{ type: Output }]
    };
    return MasonryGalleryComponent;
}());
export { MasonryGalleryComponent };
if (false) {
    /** @type {?} */
    MasonryGalleryComponent.prototype.images;
    /** @type {?} */
    MasonryGalleryComponent.prototype.width;
    /** @type {?} */
    MasonryGalleryComponent.prototype.gutter;
    /** @type {?} */
    MasonryGalleryComponent.prototype.verticalGutter;
    /** @type {?} */
    MasonryGalleryComponent.prototype.imageClasses;
    /** @type {?} */
    MasonryGalleryComponent.prototype.clickImage;
    /** @type {?} */
    MasonryGalleryComponent.prototype.removeComplete;
    /** @type {?} */
    MasonryGalleryComponent.prototype.layoutComplete;
    /** @type {?} */
    MasonryGalleryComponent.prototype.galleryGuid;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.mansonryItemSelectorClass;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.activeImages;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.msnry;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.grid;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.changesToProcess;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.viewReady;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.renderer;
}
/**
 * @record
 */
function ActiveImage() { }
if (false) {
    /** @type {?} */
    ActiveImage.prototype.id;
    /** @type {?} */
    ActiveImage.prototype.image;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFzb25yeS1nYWxsZXJ5LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1tYXNvbnJ5LWdhbGxlcnkvIiwic291cmNlcyI6WyJsaWIvbWFzb25yeS1nYWxsZXJ5LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUVILFNBQVMsRUFDVCxZQUFZLEVBQ1osS0FBSyxFQUdMLE1BQU0sRUFDTixTQUFTLEVBRVQsdUJBQXVCLEdBQzFCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sa0JBQWtCLE1BQU0sY0FBYyxDQUFDO0FBQzlDLE9BQU8sS0FBSyxPQUFPLE1BQU0sZ0JBQWdCLENBQUM7QUFHMUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUV4QztJQTJCSSxpQ0FBb0IsUUFBbUI7UUFBbkIsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQXBCOUIsV0FBTSxHQUEyQixFQUFFLENBQUM7UUFDcEMsVUFBSyxHQUFXLEdBQUcsQ0FBQztRQUNwQixXQUFNLEdBQVcsQ0FBQyxDQUFDO1FBQ25CLG1CQUFjLEdBQVcsQ0FBQyxDQUFDO1FBQzNCLGlCQUFZLEdBQWEsRUFBRSxDQUFDO1FBRTNCLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBd0IsQ0FBQztRQUN0RCxtQkFBYyxHQUFHLElBQUksWUFBWSxFQUFTLENBQUM7UUFDM0MsbUJBQWMsR0FBRyxJQUFJLFlBQVksRUFBUyxDQUFDO1FBRXJDLGdCQUFXLEdBQVcsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRXpDLDhCQUF5QixHQUFHLGVBQWEsSUFBSSxDQUFDLFdBQWEsQ0FBQztRQUM1RCxpQkFBWSxHQUFrQixFQUFFLENBQUM7UUFLMUMsY0FBUyxHQUFZLEtBQUssQ0FBQztJQUVRLENBQUM7Ozs7O0lBRTVDLDZDQUFXOzs7O0lBQVgsVUFBWSxPQUFzQjtRQUM5QixJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUU7WUFDL0MsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ2pCLDZCQUE2QjtnQkFDN0IsSUFBSSxDQUFDLGdCQUFnQixHQUFHLE9BQU8sQ0FBQzthQUNuQztpQkFBTTtnQkFDSCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQy9CO1NBQ0o7SUFDTCxDQUFDOzs7O0lBRUQsNkNBQVc7OztJQUFYO1FBQ0ksSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1osSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUN4QjtJQUNMLENBQUM7Ozs7O0lBRUQsNkNBQVc7Ozs7SUFBWCxVQUFZLEtBQTJCO1FBQ25DLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Ozs7SUFFRCxpREFBZTs7O0lBQWY7UUFDSSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFbkIscUJBQXFCO1FBQ3JCLElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3ZCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDMUMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLFNBQVMsQ0FBQztTQUNyQztJQUNMLENBQUM7Ozs7O0lBRUQsMkNBQVM7Ozs7SUFBVCxVQUFVLE1BQThCO1FBQ3BDLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzdCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNuQztJQUNMLENBQUM7Ozs7O0lBRUQsOENBQVk7Ozs7SUFBWixVQUFhLE1BQThCO1FBQTNDLGlCQU1DO1FBTEcsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDN0IsTUFBTSxDQUFDLE9BQU87Ozs7WUFBQyxVQUFBLEtBQUs7Z0JBQ2hCLEtBQUksQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2QyxDQUFDLEVBQUMsQ0FBQztTQUNOO0lBQ0wsQ0FBQzs7Ozs7O0lBRU8sK0NBQWE7Ozs7O0lBQXJCLFVBQXNCLE9BQXNCOztZQUNsQyxlQUFlLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQztRQUU5RCxnQ0FBZ0M7UUFDaEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFNUMsNkJBQTZCO1FBQzdCLElBQUksQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3JELENBQUM7Ozs7OztJQUVPLDBEQUF3Qjs7Ozs7SUFBaEMsVUFDSSxPQUFzQjs7WUFLbEIsV0FBVyxHQUEyQixFQUFFOztZQUN0QyxhQUFhLEdBQTJCLEVBQUU7O1lBRTFDLGNBQWMsR0FBRyxtQkFBQSxPQUFPLENBQUMsTUFBTTthQUNoQyxZQUFZLEVBQTBCOztZQUNyQyxjQUFjLEdBQUcsbUJBQUEsT0FBTyxDQUFDLE1BQU07YUFDaEMsYUFBYSxFQUEwQjtRQUU1QyxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ2pCLDBCQUEwQjtZQUMxQixXQUFXLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7U0FDN0M7YUFBTTtZQUNILHVCQUF1QjtZQUN2QixjQUFjLENBQUMsT0FBTzs7OztZQUFDLFVBQUEsUUFBUTs7b0JBQ3JCLGFBQWEsR0FBRyxjQUFjLENBQUMsSUFBSTs7OztnQkFDckMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxLQUFLLFFBQVEsQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLEVBQTVELENBQTRELEVBQ3BFO2dCQUVELElBQUksYUFBYSxFQUFFO29CQUNmLHVEQUF1RDtpQkFDMUQ7cUJBQU07b0JBQ0gsZUFBZTtvQkFDZixXQUFXLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUM5QjtZQUNMLENBQUMsRUFBQyxDQUFDO1lBRUgseUJBQXlCO1lBQ3pCLGNBQWMsQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQSxRQUFROztvQkFDckIsYUFBYSxHQUFHLGNBQWMsQ0FBQyxJQUFJOzs7O2dCQUNyQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLEtBQUssUUFBUSxDQUFDLFFBQVEsQ0FBQyxXQUFXLEVBQUUsRUFBNUQsQ0FBNEQsRUFDcEU7Z0JBRUQsSUFBSSxhQUFhLEVBQUU7b0JBQ2YsdURBQXVEO2lCQUMxRDtxQkFBTTtvQkFDSCxtQkFBbUI7b0JBQ25CLGFBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7aUJBQ2hDO1lBQ0wsQ0FBQyxFQUFDLENBQUM7U0FDTjtRQUVELE9BQU87WUFDSCxXQUFXLEVBQUUsV0FBVztZQUN4QixhQUFhLEVBQUUsYUFBYTtTQUMvQixDQUFDO0lBQ04sQ0FBQzs7Ozs7SUFFTyw2Q0FBVzs7OztJQUFuQjtRQUNJLElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFdEQscUNBQXFDO1FBQ3JDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUV6QixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNaLE1BQU0sS0FBSyxDQUNQLDhEQUNBLElBQUksQ0FBQyxXQUFXLE1BQ2IsQ0FDTixDQUFDO1NBQ0w7UUFFRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7O1lBRWhDLFlBQVksRUFBRSxHQUFHLEdBQUcsSUFBSSxDQUFDLHlCQUF5QjtZQUNsRCxXQUFXLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDdkIsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO1NBQ3RCLENBQUMsQ0FBQzs7WUFFRyxJQUFJLEdBQUcsSUFBSTtRQUVqQixJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxnQkFBZ0I7Ozs7UUFBRSxVQUFVLEtBQUs7WUFDM0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxFQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxnQkFBZ0I7Ozs7UUFBRSxVQUFVLEtBQUs7WUFDM0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxFQUFDLENBQUM7SUFDUCxDQUFDOzs7Ozs7SUFFTyx3REFBc0I7Ozs7O0lBQTlCLFVBQStCLEtBQTJCOzs7WUFFaEQsYUFBYSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSTs7OztRQUN4QyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxLQUFLLEtBQUssQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLEVBQS9ELENBQStELEVBQ3ZFO1FBRUQsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUNoQixpREFBaUQ7WUFDakQsT0FBTyxDQUFDLElBQUksQ0FDUixxQkFDQSxLQUFLLENBQUMsUUFBUSxrUkFHMEMsQ0FDM0QsQ0FBQztZQUNGLE9BQU87U0FDVjs7O1lBR0ssU0FBUyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQztRQUUzRCxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ1osNkJBQTZCO1lBQzdCLE9BQU8sQ0FBQyxJQUFJLENBQ1IscUJBQ0EsYUFBYSxDQUFDLEVBQUUsdUVBQ29ELENBQ3ZFLENBQUM7WUFDRixPQUFPO1NBQ1Y7UUFFRCw0QkFBNEI7UUFDNUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFN0IsaUJBQWlCO1FBQ2pCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFcEIsMEJBQTBCO1FBQzFCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTs7Z0JBQ3pDLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUN4QyxJQUNJLFdBQVcsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRTtnQkFDeEMsYUFBYSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLEVBQzVDO2dCQUNFLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQzthQUNsQztTQUNKO0lBQ0wsQ0FBQzs7Ozs7O0lBRU8sb0RBQWtCOzs7OztJQUExQixVQUEyQixNQUE4QjtRQUF6RCxpQkFzREM7UUFyREcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDWixNQUFNLEtBQUssQ0FDUCxzRUFBc0UsQ0FDekUsQ0FBQztTQUNMOztZQUVLLGFBQWEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUM7UUFFekQsTUFBTSxDQUFDLE9BQU87Ozs7UUFBQyxVQUFBLEtBQUs7OztnQkFFVixPQUFPLEdBQUcsS0FBSSxDQUFDLFVBQVUsRUFBRTs7O2dCQUczQixTQUFTLEdBQUcsS0FBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDO1lBQ3BELFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3RDLFNBQVMsQ0FBQyxZQUFZLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUM7WUFDeEUsU0FBUyxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzlDLHFGQUFxRjtZQUNyRixTQUFTLENBQUMsWUFBWSxDQUNsQixPQUFPLEVBQ1AsMkJBQXlCLEtBQUksQ0FBQyxLQUFLLDJCQUNuQyxLQUFJLENBQUMsY0FBYyxPQUNmLENBQ1AsQ0FBQztZQUNGLFNBQVMsQ0FBQyxTQUFTLEdBQUcsS0FBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQzNDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPOzs7WUFBRTtnQkFDaEMsS0FBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUM1QixDQUFDLEVBQUMsQ0FBQztZQUVILDZCQUE2QjtZQUM3QixLQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQztnQkFDbkIsRUFBRSxFQUFFLE9BQU87Z0JBQ1gsS0FBSyxFQUFFLEtBQUs7YUFDZixDQUFDLENBQUM7WUFFSCwwQ0FBMEM7WUFDMUMsS0FBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3hELENBQUMsRUFBQyxDQUFDO1FBRUgsa0JBQWtCO1FBQ2xCLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7OztZQUc5QyxPQUFPLEdBQUcsa0JBQWtCLENBQUMsYUFBYSxDQUFDO1FBQ2pELE9BQU8sQ0FBQyxFQUFFLENBQUMsVUFBVTs7Ozs7UUFBRSxVQUFDLFFBQVEsRUFBRSxLQUFLO1lBQ25DLElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDaEIsS0FBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsS0FBSSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2hELGVBQWU7Z0JBQ2YsS0FBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQ3RELEtBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDL0IsS0FBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQzthQUM1QjtRQUNMLENBQUMsRUFBQyxDQUFDO0lBQ1AsQ0FBQzs7Ozs7SUFFTywrQ0FBYTs7OztJQUFyQjs7WUFDUSxTQUFTLEdBQUcsSUFBSSxDQUFDLHlCQUF5QjtRQUU5QyxJQUFJLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFOztnQkFDN0MsV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztZQUUvQyxTQUFTLElBQUksR0FBRyxHQUFHLFdBQVcsQ0FBQztTQUNsQztRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7Ozs7O0lBRU8sNENBQVU7Ozs7SUFBbEI7UUFDSSxPQUFPLElBQUksQ0FBQyxXQUFXLEdBQUcsR0FBRyxHQUFHLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUN4RCxDQUFDOztnQkFqU0osU0FBUyxTQUFDO29CQUNQLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNO29CQUMvQyxRQUFRLEVBQUUscUJBQXFCO29CQUMvQixRQUFRLEVBQUUsZ0NBQWdDO2lCQUM3Qzs7OztnQkFkRyxTQUFTOzs7eUJBaUJSLEtBQUs7d0JBQ0wsS0FBSzt5QkFDTCxLQUFLO2lDQUNMLEtBQUs7K0JBQ0wsS0FBSzs2QkFFTCxNQUFNO2lDQUNOLE1BQU07aUNBQ04sTUFBTTs7SUFtUlgsOEJBQUM7Q0FBQSxBQWxTRCxJQWtTQztTQTdSWSx1QkFBdUI7OztJQUVoQyx5Q0FBNkM7O0lBQzdDLHdDQUE2Qjs7SUFDN0IseUNBQTRCOztJQUM1QixpREFBb0M7O0lBQ3BDLCtDQUFxQzs7SUFFckMsNkNBQWdFOztJQUNoRSxpREFBcUQ7O0lBQ3JELGlEQUFxRDs7SUFFckQsOENBQTBEOzs7OztJQUUxRCw0REFBNkU7Ozs7O0lBQzdFLCtDQUFrRDs7Ozs7SUFFbEQsd0NBQW9COzs7OztJQUNwQix1Q0FBbUI7Ozs7O0lBQ25CLG1EQUF5Qzs7Ozs7SUFDekMsNENBQW1DOzs7OztJQUV2QiwyQ0FBMkI7Ozs7O0FBeVEzQywwQkFHQzs7O0lBRkcseUJBQVc7O0lBQ1gsNEJBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIEFmdGVyVmlld0luaXQsXHJcbiAgICBDb21wb25lbnQsXHJcbiAgICBFdmVudEVtaXR0ZXIsXHJcbiAgICBJbnB1dCxcclxuICAgIE9uQ2hhbmdlcyxcclxuICAgIE9uRGVzdHJveSxcclxuICAgIE91dHB1dCxcclxuICAgIFJlbmRlcmVyMixcclxuICAgIFNpbXBsZUNoYW5nZXMsXHJcbiAgICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IGltYWdlc0xvYWRlZE1ldGhvZCBmcm9tICdpbWFnZXNsb2FkZWQnO1xyXG5pbXBvcnQgKiBhcyBtYXNvbnJ5IGZyb20gJ21hc29ucnktbGF5b3V0JztcclxuXHJcbmltcG9ydCB7IElNYXNvbnJ5R2FsbGVyeUltYWdlIH0gZnJvbSAnLi9tYXNvbnJ5LWdhbGxlcnktbW9kZWxzJztcclxuaW1wb3J0IHsgdXRpbGl0aWVzIH0gZnJvbSAnLi91dGlsaXRpZXMnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcclxuICAgIHNlbGVjdG9yOiAnbmd4LW1hc29ucnktZ2FsbGVyeScsXHJcbiAgICB0ZW1wbGF0ZTogJzxkaXYgW2lkXT1cImdhbGxlcnlHdWlkXCI+PC9kaXY+J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgTWFzb25yeUdhbGxlcnlDb21wb25lbnRcclxuICAgIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xyXG4gICAgQElucHV0KCkgaW1hZ2VzOiBJTWFzb25yeUdhbGxlcnlJbWFnZVtdID0gW107XHJcbiAgICBASW5wdXQoKSB3aWR0aDogbnVtYmVyID0gMzMwO1xyXG4gICAgQElucHV0KCkgZ3V0dGVyOiBudW1iZXIgPSA1O1xyXG4gICAgQElucHV0KCkgdmVydGljYWxHdXR0ZXI6IG51bWJlciA9IDU7XHJcbiAgICBASW5wdXQoKSBpbWFnZUNsYXNzZXM6IHN0cmluZ1tdID0gW107XHJcblxyXG4gICAgQE91dHB1dCgpIGNsaWNrSW1hZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPElNYXNvbnJ5R2FsbGVyeUltYWdlPigpO1xyXG4gICAgQE91dHB1dCgpIHJlbW92ZUNvbXBsZXRlID0gbmV3IEV2ZW50RW1pdHRlcjxhbnlbXT4oKTtcclxuICAgIEBPdXRwdXQoKSBsYXlvdXRDb21wbGV0ZSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55W10+KCk7XHJcblxyXG4gICAgcHVibGljIHJlYWRvbmx5IGdhbGxlcnlHdWlkOiBzdHJpbmcgPSB1dGlsaXRpZXMubmV3R3VpZCgpO1xyXG5cclxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWFuc29ucnlJdGVtU2VsZWN0b3JDbGFzcyA9IGBncmlkLWl0ZW0tJHt0aGlzLmdhbGxlcnlHdWlkfWA7XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFjdGl2ZUltYWdlczogQWN0aXZlSW1hZ2VbXSA9IFtdO1xyXG5cclxuICAgIHByaXZhdGUgbXNucnk/OiBhbnk7XHJcbiAgICBwcml2YXRlIGdyaWQ/OiBhbnk7XHJcbiAgICBwcml2YXRlIGNoYW5nZXNUb1Byb2Nlc3M/OiBTaW1wbGVDaGFuZ2VzO1xyXG4gICAgcHJpdmF0ZSB2aWV3UmVhZHk6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIpIHsgfVxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcclxuICAgICAgICBpZiAoY2hhbmdlcy5pbWFnZXMgJiYgY2hhbmdlcy5pbWFnZXMuY3VycmVudFZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy52aWV3UmVhZHkpIHtcclxuICAgICAgICAgICAgICAgIC8vIHByb2Nlc3MgaW1hZ2VzIG9uY2Ugd2UgY2FuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZXNUb1Byb2Nlc3MgPSBjaGFuZ2VzO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW1hZ2VzKGNoYW5nZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLm1zbnJ5KSB7XHJcbiAgICAgICAgICAgIHRoaXMubXNucnkuZGVzdHJveSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBoYW5kbGVDbGljayhpbWFnZTogSU1hc29ucnlHYWxsZXJ5SW1hZ2UpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmNsaWNrSW1hZ2UubmV4dChpbWFnZSk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMudmlld1JlYWR5ID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLmluaXRNYXNvbnJ5KCk7XHJcblxyXG4gICAgICAgIC8vIHByb2Nlc3MgaW1hZ2VzIG5vd1xyXG4gICAgICAgIGlmICh0aGlzLmNoYW5nZXNUb1Byb2Nlc3MpIHtcclxuICAgICAgICAgICAgdGhpcy5wcm9jZXNzSW1hZ2VzKHRoaXMuY2hhbmdlc1RvUHJvY2Vzcyk7XHJcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlc1RvUHJvY2VzcyA9IHVuZGVmaW5lZDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgYWRkSW1hZ2VzKGltYWdlczogSU1hc29ucnlHYWxsZXJ5SW1hZ2VbXSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChpbWFnZXMgJiYgaW1hZ2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5hZGRJbWFnZXNUb0dhbGxlcnkoaW1hZ2VzKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlSW1hZ2VzKGltYWdlczogSU1hc29ucnlHYWxsZXJ5SW1hZ2VbXSk6IHZvaWQge1xyXG4gICAgICAgIGlmIChpbWFnZXMgJiYgaW1hZ2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgaW1hZ2VzLmZvckVhY2goaW1hZ2UgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVJbWFnZUZyb21HYWxsZXJ5KGltYWdlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcHJvY2Vzc0ltYWdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgaW1hZ2VzVG9Qcm9jZXNzID0gdGhpcy5nZXRBZGRlZEFuZFJlbW92ZXNJbWFnZXMoY2hhbmdlcyk7XHJcblxyXG4gICAgICAgIC8vIGFkZCBpbWFnZXMgdG8gbWFuc29ucnkgbGF5b3V0XHJcbiAgICAgICAgdGhpcy5hZGRJbWFnZXMoaW1hZ2VzVG9Qcm9jZXNzLmFkZGVkSW1hZ2VzKTtcclxuXHJcbiAgICAgICAgLy8gcmVtb3ZlcyBpbWFnZXMgZnJvbSBsYXlvdXRcclxuICAgICAgICB0aGlzLnJlbW92ZUltYWdlcyhpbWFnZXNUb1Byb2Nlc3MucmVtb3ZlZEltYWdlcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRBZGRlZEFuZFJlbW92ZXNJbWFnZXMoXHJcbiAgICAgICAgY2hhbmdlczogU2ltcGxlQ2hhbmdlc1xyXG4gICAgKToge1xyXG4gICAgICAgICAgICBhZGRlZEltYWdlczogSU1hc29ucnlHYWxsZXJ5SW1hZ2VbXTtcclxuICAgICAgICAgICAgcmVtb3ZlZEltYWdlczogSU1hc29ucnlHYWxsZXJ5SW1hZ2VbXTtcclxuICAgICAgICB9IHtcclxuICAgICAgICBsZXQgYWRkZWRJbWFnZXM6IElNYXNvbnJ5R2FsbGVyeUltYWdlW10gPSBbXTtcclxuICAgICAgICBjb25zdCByZW1vdmVkSW1hZ2VzOiBJTWFzb25yeUdhbGxlcnlJbWFnZVtdID0gW107XHJcblxyXG4gICAgICAgIGNvbnN0IG5ld0ltYWdlc1ZhbHVlID0gY2hhbmdlcy5pbWFnZXNcclxuICAgICAgICAgICAgLmN1cnJlbnRWYWx1ZSBhcyBJTWFzb25yeUdhbGxlcnlJbWFnZVtdO1xyXG4gICAgICAgIGNvbnN0IG9sZEltYWdlc1ZhbHVlID0gY2hhbmdlcy5pbWFnZXNcclxuICAgICAgICAgICAgLnByZXZpb3VzVmFsdWUgYXMgSU1hc29ucnlHYWxsZXJ5SW1hZ2VbXTtcclxuXHJcbiAgICAgICAgaWYgKCFvbGRJbWFnZXNWYWx1ZSkge1xyXG4gICAgICAgICAgICAvLyBhbGwgaW1hZ2VzIGFyZSBuZXcgb25lc1xyXG4gICAgICAgICAgICBhZGRlZEltYWdlcyA9IGNoYW5nZXMuaW1hZ2VzLmN1cnJlbnRWYWx1ZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBwcm9jZXNzIGFkZGVkIGltYWdlc1xyXG4gICAgICAgICAgICBuZXdJbWFnZXNWYWx1ZS5mb3JFYWNoKG5ld0ltYWdlID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nSW1hZ2UgPSBvbGRJbWFnZXNWYWx1ZS5maW5kKFxyXG4gICAgICAgICAgICAgICAgICAgIG0gPT4gbS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpID09PSBuZXdJbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpXHJcbiAgICAgICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ0ltYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaW1hZ2Ugd2FzIGluIHByZXZpb3VzIHZhbHVlICYmIGlzIGluIG5ldywgZG8gbm90aGluZ1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBpbWFnZSBpcyBuZXdcclxuICAgICAgICAgICAgICAgICAgICBhZGRlZEltYWdlcy5wdXNoKG5ld0ltYWdlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyBwcm9jZXNzIHJlbW92ZWQgaW1hZ2VzXHJcbiAgICAgICAgICAgIG9sZEltYWdlc1ZhbHVlLmZvckVhY2gob2xkSW1hZ2UgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdJbWFnZSA9IG5ld0ltYWdlc1ZhbHVlLmZpbmQoXHJcbiAgICAgICAgICAgICAgICAgICAgbSA9PiBtLmltYWdlVXJsLnRvTG93ZXJDYXNlKCkgPT09IG9sZEltYWdlLmltYWdlVXJsLnRvTG93ZXJDYXNlKClcclxuICAgICAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nSW1hZ2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBpbWFnZSB3YXMgaW4gcHJldmlvdXMgdmFsdWUgJiYgaXMgaW4gbmV3LCBkbyBub3RoaW5nXHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGltYWdlIGlzIHJlbW92ZWRcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVkSW1hZ2VzLnB1c2gob2xkSW1hZ2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGFkZGVkSW1hZ2VzOiBhZGRlZEltYWdlcyxcclxuICAgICAgICAgICAgcmVtb3ZlZEltYWdlczogcmVtb3ZlZEltYWdlc1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0TWFzb25yeSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmdyaWQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmdhbGxlcnlHdWlkKTtcclxuXHJcbiAgICAgICAgLy8gcmVtb3ZlIGFsbCBleGlzdGluZyBkYXRhIGZyb20gZ3JpZFxyXG4gICAgICAgIHRoaXMuZ3JpZC5pbm5lckhUTUwgPSAnJztcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmdyaWQpIHtcclxuICAgICAgICAgICAgdGhyb3cgRXJyb3IoXHJcbiAgICAgICAgICAgICAgICBgQ291bGQgbm90IGluaXQgbWFuc29yeSBkdWUgdG8gbm9uIGV4aXN0aW5nIGVsZW0gd2l0aCBpZCAnJHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZ2FsbGVyeUd1aWRcclxuICAgICAgICAgICAgICAgIH0nYFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5tc25yeSA9IG5ldyBtYXNvbnJ5KHRoaXMuZ3JpZCwge1xyXG4gICAgICAgICAgICAvLyBvcHRpb25zLi4uXHJcbiAgICAgICAgICAgIGl0ZW1TZWxlY3RvcjogJy4nICsgdGhpcy5tYW5zb25yeUl0ZW1TZWxlY3RvckNsYXNzLFxyXG4gICAgICAgICAgICBjb2x1bW5XaWR0aDogdGhpcy53aWR0aCxcclxuICAgICAgICAgICAgZ3V0dGVyOiB0aGlzLmd1dHRlcixcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXM7XHJcblxyXG4gICAgICAgIHRoaXMubXNucnkub24oJ2xheW91dENvbXBsZXRlJywgZnVuY3Rpb24gKGl0ZW1zKSB7XHJcbiAgICAgICAgICAgIHRoYXQubGF5b3V0Q29tcGxldGUubmV4dChpdGVtcyk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMubXNucnkub24oJ3JlbW92ZUNvbXBsZXRlJywgZnVuY3Rpb24gKGl0ZW1zKSB7XHJcbiAgICAgICAgICAgIHRoYXQucmVtb3ZlQ29tcGxldGUubmV4dChpdGVtcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZW1vdmVJbWFnZUZyb21HYWxsZXJ5KGltYWdlOiBJTWFzb25yeUdhbGxlcnlJbWFnZSk6IHZvaWQge1xyXG4gICAgICAgIC8vIGdldCBpbWFnZSBndWlkXHJcbiAgICAgICAgY29uc3QgaW1hZ2VJZFJlc3VsdCA9IHRoaXMuYWN0aXZlSW1hZ2VzLmZpbmQoXHJcbiAgICAgICAgICAgIG0gPT4gbS5pbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpID09PSBpbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKCFpbWFnZUlkUmVzdWx0KSB7XHJcbiAgICAgICAgICAgIC8vIGltYWdlIHdhcyBub3QgZm91bmQsIHRoaXMgaXMgcHJvYmFibHkgYW4gZXJyb3JcclxuICAgICAgICAgICAgY29uc29sZS53YXJuKFxyXG4gICAgICAgICAgICAgICAgYEltYWdlIHdpdGggdXJsICcke1xyXG4gICAgICAgICAgICAgICAgaW1hZ2UuaW1hZ2VVcmxcclxuICAgICAgICAgICAgICAgIH0nIHdhcyBub3QgZm91bmQuIElmIHlvdSBhcmUgYWRkaW5nIGltYWdlcywgbWFrZSBzdXJlIHRvICdyZXBsYWNlJyB0aGUgaW1hZ2VzIGFycmF5IHdpdGggYSBuZXcgb25lXHJcbiAgICAgICAgICAgICAgICBzbyB0aGF0IGRldGVjdGlvbiBjaGFuZ2UgY2FuIGJlIGV4ZWN1dGVkIGluc3RlYWQgb2YganVzdCBhZGRpbmcgYW4gaW1hZ2UgdG8gYXJyYXlcclxuICAgICAgICAgICAgICAgICh3aGljaCBkb2Vzbid0IGZpcmUgY2hhbmdlIGRldGVjdGlvbiBvbiBhcnJheSBwcm9wZXJ0eSlgXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIGZpbmQgaW1hZ2UgYmFzZWQgb24gaXRzIGlkXHJcbiAgICAgICAgY29uc3QgaW1hZ2VFbGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaW1hZ2VJZFJlc3VsdC5pZCk7XHJcblxyXG4gICAgICAgIGlmICghaW1hZ2VFbGVtKSB7XHJcbiAgICAgICAgICAgIC8vIGltYWdlIHdhcyBub3QgZm91bmQgaW4gRE9NXHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcclxuICAgICAgICAgICAgICAgIGBJbWFnZSB3aXRoIGlkICd7JHtcclxuICAgICAgICAgICAgICAgIGltYWdlSWRSZXN1bHQuaWRcclxuICAgICAgICAgICAgICAgIH19JyB3YXMgbm90IGZvdW5kIGluIERPTS4gSGF2ZSB5b3UgbWFuaXB1bGF0ZWQgdGhlIERPTSBpbiBzb21lIHdheT9gXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIHJlbW92ZSBpbWFnZSBmcm9tIGdhbGxlcnlcclxuICAgICAgICB0aGlzLm1zbnJ5LnJlbW92ZShpbWFnZUVsZW0pO1xyXG5cclxuICAgICAgICAvLyByZWZyZXNoIGxheW91dFxyXG4gICAgICAgIHRoaXMubXNucnkubGF5b3V0KCk7XHJcblxyXG4gICAgICAgIC8vIHJlbW92ZSBpbWFnZSBmcm9tIGFycmF5XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmFjdGl2ZUltYWdlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBjb25zdCBpZFdpdGhJbWFnZSA9IHRoaXMuYWN0aXZlSW1hZ2VzW2ldO1xyXG4gICAgICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgICAgICBpZFdpdGhJbWFnZS5pbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpID09PVxyXG4gICAgICAgICAgICAgICAgaW1hZ2VJZFJlc3VsdC5pbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpXHJcbiAgICAgICAgICAgICkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVJbWFnZXMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYWRkSW1hZ2VzVG9HYWxsZXJ5KGltYWdlczogSU1hc29ucnlHYWxsZXJ5SW1hZ2VbXSk6IHZvaWQge1xyXG4gICAgICAgIGlmICghdGhpcy5ncmlkKSB7XHJcbiAgICAgICAgICAgIHRocm93IEVycm9yKFxyXG4gICAgICAgICAgICAgICAgJ0dyaWQgZWxlbWVudCBpcyBub3QgeWV0IHJlYWR5LCBhcmUgeW91IHRyeWluZyB0byBhZGQgaW1hZ2UgdG9vIHNvb24/J1xyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaW1hZ2VzV3JhcHBlciA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG5cclxuICAgICAgICBpbWFnZXMuZm9yRWFjaChpbWFnZSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGdlbmVyYXRlIHVuaXF1ZSBpbWFnZSBpZFxyXG4gICAgICAgICAgICBjb25zdCBpbWFnZUlkID0gdGhpcy5nZXRJbWFnZUlkKCk7XHJcblxyXG4gICAgICAgICAgICAvLyBjcmVhdGUgZWxlbWVudFxyXG4gICAgICAgICAgICBjb25zdCBpbWFnZUVsZW0gPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xyXG4gICAgICAgICAgICBpbWFnZUVsZW0uc2V0QXR0cmlidXRlKCdpZCcsIGltYWdlSWQpO1xyXG4gICAgICAgICAgICBpbWFnZUVsZW0uc2V0QXR0cmlidXRlKCdhbHQnLCBpbWFnZS5hbHQgPyBpbWFnZS5hbHQgOiAnbm8gZGVzY3JpcHRpb24nKTtcclxuICAgICAgICAgICAgaW1hZ2VFbGVtLnNldEF0dHJpYnV0ZSgnc3JjJywgaW1hZ2UuaW1hZ2VVcmwpO1xyXG4gICAgICAgICAgICAvLyBub3RlIC0gaW1hZ2VzIGFyZSBoaWRkZW4gYnkgZGVmYXVsdCBhbmQgc2hvdWxkIGJlIHNob3duIG9ubHkgYWZ0ZXIgdGhleSBhcmUgbG9hZGVkXHJcbiAgICAgICAgICAgIGltYWdlRWxlbS5zZXRBdHRyaWJ1dGUoXHJcbiAgICAgICAgICAgICAgICAnc3R5bGUnLFxyXG4gICAgICAgICAgICAgICAgYGRpc3BsYXk6IG5vbmU7IHdpZHRoOiAke3RoaXMud2lkdGh9cHg7IG1hcmdpbi1ib3R0b206ICR7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnZlcnRpY2FsR3V0dGVyXHJcbiAgICAgICAgICAgICAgICB9cHhgXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIGltYWdlRWxlbS5jbGFzc05hbWUgPSB0aGlzLmdldEltYWdlQ2xhc3MoKTtcclxuICAgICAgICAgICAgaW1hZ2VFbGVtLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVDbGljayhpbWFnZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gc3RvcmUgZ3VpZCB3aXRoIHRoaXMgaW1hZ2VcclxuICAgICAgICAgICAgdGhpcy5hY3RpdmVJbWFnZXMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBpZDogaW1hZ2VJZCxcclxuICAgICAgICAgICAgICAgIGltYWdlOiBpbWFnZVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIGFkZCB0byBkb20gYW5kIG1hbnNvcnkgJiByZWZyZXNoIGxheW91dFxyXG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKGltYWdlc1dyYXBwZXIsIGltYWdlRWxlbSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIGFkZCBodG1sIHRvIGRvbVxyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy5ncmlkLCBpbWFnZXNXcmFwcGVyKTtcclxuXHJcbiAgICAgICAgLy8gYWRkIGltYWdlcyBvbmNlIHRoZXkgYXJlIGxvYWRlZFxyXG4gICAgICAgIGNvbnN0IGltZ0xvYWQgPSBpbWFnZXNMb2FkZWRNZXRob2QoaW1hZ2VzV3JhcHBlcik7XHJcbiAgICAgICAgaW1nTG9hZC5vbigncHJvZ3Jlc3MnLCAoaW5zdGFuY2UsIGltYWdlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChpbWFnZS5pc0xvYWRlZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZCh0aGlzLmdyaWQsIGltYWdlLmltZyk7XHJcbiAgICAgICAgICAgICAgICAvLyB1bmhpZGUgaW1hZ2VcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2V0U3R5bGUoaW1hZ2UuaW1nLCAnZGlzcGxheScsICdibG9jaycpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tc25yeS5hcHBlbmRlZChpbWFnZS5pbWcpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5tc25yeS5yZWxvYWRJdGVtcygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRJbWFnZUNsYXNzKCk6IHN0cmluZyB7XHJcbiAgICAgICAgbGV0IGNsYXNzTmFtZSA9IHRoaXMubWFuc29ucnlJdGVtU2VsZWN0b3JDbGFzcztcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW1hZ2VDbGFzc2VzICYmIHRoaXMuaW1hZ2VDbGFzc2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgY29uc3QgY3VzdG9tQ2xhc3MgPSB0aGlzLmltYWdlQ2xhc3Nlcy5qb2luKCcgJyk7XHJcblxyXG4gICAgICAgICAgICBjbGFzc05hbWUgKz0gJyAnICsgY3VzdG9tQ2xhc3M7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gY2xhc3NOYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0SW1hZ2VJZCgpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdhbGxlcnlHdWlkICsgJ18nICsgdXRpbGl0aWVzLm5ld0d1aWQoKTtcclxuICAgIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIEFjdGl2ZUltYWdlIHtcclxuICAgIGlkOiBzdHJpbmc7XHJcbiAgICBpbWFnZTogSU1hc29ucnlHYWxsZXJ5SW1hZ2U7XHJcbn1cclxuIl19