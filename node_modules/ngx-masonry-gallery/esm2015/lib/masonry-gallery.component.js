/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, Input, Output, Renderer2, ChangeDetectionStrategy, } from '@angular/core';
import imagesLoadedMethod from 'imagesloaded';
import * as masonry from 'masonry-layout';
import { utilities } from './utilities';
export class MasonryGalleryComponent {
    /**
     * @param {?} renderer
     */
    constructor(renderer) {
        this.renderer = renderer;
        this.images = [];
        this.width = 330;
        this.gutter = 5;
        this.verticalGutter = 5;
        this.imageClasses = [];
        this.clickImage = new EventEmitter();
        this.removeComplete = new EventEmitter();
        this.layoutComplete = new EventEmitter();
        this.galleryGuid = utilities.newGuid();
        this.mansonryItemSelectorClass = `grid-item-${this.galleryGuid}`;
        this.activeImages = [];
        this.viewReady = false;
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.images && changes.images.currentValue) {
            if (!this.viewReady) {
                // process images once we can
                this.changesToProcess = changes;
            }
            else {
                this.processImages(changes);
            }
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        if (this.msnry) {
            this.msnry.destroy();
        }
    }
    /**
     * @param {?} image
     * @return {?}
     */
    handleClick(image) {
        this.clickImage.next(image);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.viewReady = true;
        this.initMasonry();
        // process images now
        if (this.changesToProcess) {
            this.processImages(this.changesToProcess);
            this.changesToProcess = undefined;
        }
    }
    /**
     * @param {?} images
     * @return {?}
     */
    addImages(images) {
        if (images && images.length > 0) {
            this.addImagesToGallery(images);
        }
    }
    /**
     * @param {?} images
     * @return {?}
     */
    removeImages(images) {
        if (images && images.length > 0) {
            images.forEach((/**
             * @param {?} image
             * @return {?}
             */
            image => {
                this.removeImageFromGallery(image);
            }));
        }
    }
    /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    processImages(changes) {
        /** @type {?} */
        const imagesToProcess = this.getAddedAndRemovesImages(changes);
        // add images to mansonry layout
        this.addImages(imagesToProcess.addedImages);
        // removes images from layout
        this.removeImages(imagesToProcess.removedImages);
    }
    /**
     * @private
     * @param {?} changes
     * @return {?}
     */
    getAddedAndRemovesImages(changes) {
        /** @type {?} */
        let addedImages = [];
        /** @type {?} */
        const removedImages = [];
        /** @type {?} */
        const newImagesValue = (/** @type {?} */ (changes.images
            .currentValue));
        /** @type {?} */
        const oldImagesValue = (/** @type {?} */ (changes.images
            .previousValue));
        if (!oldImagesValue) {
            // all images are new ones
            addedImages = changes.images.currentValue;
        }
        else {
            // process added images
            newImagesValue.forEach((/**
             * @param {?} newImage
             * @return {?}
             */
            newImage => {
                /** @type {?} */
                const existingImage = oldImagesValue.find((/**
                 * @param {?} m
                 * @return {?}
                 */
                m => m.imageUrl.toLowerCase() === newImage.imageUrl.toLowerCase()));
                if (existingImage) {
                    // image was in previous value && is in new, do nothing
                }
                else {
                    // image is new
                    addedImages.push(newImage);
                }
            }));
            // process removed images
            oldImagesValue.forEach((/**
             * @param {?} oldImage
             * @return {?}
             */
            oldImage => {
                /** @type {?} */
                const existingImage = newImagesValue.find((/**
                 * @param {?} m
                 * @return {?}
                 */
                m => m.imageUrl.toLowerCase() === oldImage.imageUrl.toLowerCase()));
                if (existingImage) {
                    // image was in previous value && is in new, do nothing
                }
                else {
                    // image is removed
                    removedImages.push(oldImage);
                }
            }));
        }
        return {
            addedImages: addedImages,
            removedImages: removedImages
        };
    }
    /**
     * @private
     * @return {?}
     */
    initMasonry() {
        this.grid = document.getElementById(this.galleryGuid);
        // remove all existing data from grid
        this.grid.innerHTML = '';
        if (!this.grid) {
            throw Error(`Could not init mansory due to non existing elem with id '${this.galleryGuid}'`);
        }
        this.msnry = new masonry(this.grid, {
            // options...
            itemSelector: '.' + this.mansonryItemSelectorClass,
            columnWidth: this.width,
            gutter: this.gutter,
        });
        /** @type {?} */
        const that = this;
        this.msnry.on('layoutComplete', (/**
         * @param {?} items
         * @return {?}
         */
        function (items) {
            that.layoutComplete.next(items);
        }));
        this.msnry.on('removeComplete', (/**
         * @param {?} items
         * @return {?}
         */
        function (items) {
            that.removeComplete.next(items);
        }));
    }
    /**
     * @private
     * @param {?} image
     * @return {?}
     */
    removeImageFromGallery(image) {
        // get image guid
        /** @type {?} */
        const imageIdResult = this.activeImages.find((/**
         * @param {?} m
         * @return {?}
         */
        m => m.image.imageUrl.toLowerCase() === image.imageUrl.toLowerCase()));
        if (!imageIdResult) {
            // image was not found, this is probably an error
            console.warn(`Image with url '${image.imageUrl}' was not found. If you are adding images, make sure to 'replace' the images array with a new one
                so that detection change can be executed instead of just adding an image to array
                (which doesn't fire change detection on array property)`);
            return;
        }
        // find image based on its id
        /** @type {?} */
        const imageElem = document.getElementById(imageIdResult.id);
        if (!imageElem) {
            // image was not found in DOM
            console.warn(`Image with id '{${imageIdResult.id}}' was not found in DOM. Have you manipulated the DOM in some way?`);
            return;
        }
        // remove image from gallery
        this.msnry.remove(imageElem);
        // refresh layout
        this.msnry.layout();
        // remove image from array
        for (let i = 0; i < this.activeImages.length; i++) {
            /** @type {?} */
            const idWithImage = this.activeImages[i];
            if (idWithImage.image.imageUrl.toLowerCase() ===
                imageIdResult.image.imageUrl.toLowerCase()) {
                this.activeImages.splice(i, 1);
            }
        }
    }
    /**
     * @private
     * @param {?} images
     * @return {?}
     */
    addImagesToGallery(images) {
        if (!this.grid) {
            throw Error('Grid element is not yet ready, are you trying to add image too soon?');
        }
        /** @type {?} */
        const imagesWrapper = this.renderer.createElement('span');
        images.forEach((/**
         * @param {?} image
         * @return {?}
         */
        image => {
            // generate unique image id
            /** @type {?} */
            const imageId = this.getImageId();
            // create element
            /** @type {?} */
            const imageElem = this.renderer.createElement('img');
            imageElem.setAttribute('id', imageId);
            imageElem.setAttribute('alt', image.alt ? image.alt : 'no description');
            imageElem.setAttribute('src', image.imageUrl);
            // note - images are hidden by default and should be shown only after they are loaded
            imageElem.setAttribute('style', `display: none; width: ${this.width}px; margin-bottom: ${this.verticalGutter}px`);
            imageElem.className = this.getImageClass();
            imageElem.addEventListener('click', (/**
             * @return {?}
             */
            () => {
                this.handleClick(image);
            }));
            // store guid with this image
            this.activeImages.push({
                id: imageId,
                image: image
            });
            // add to dom and mansory & refresh layout
            this.renderer.appendChild(imagesWrapper, imageElem);
        }));
        // add html to dom
        this.renderer.appendChild(this.grid, imagesWrapper);
        // add images once they are loaded
        /** @type {?} */
        const imgLoad = imagesLoadedMethod(imagesWrapper);
        imgLoad.on('progress', (/**
         * @param {?} instance
         * @param {?} image
         * @return {?}
         */
        (instance, image) => {
            if (image.isLoaded) {
                this.renderer.appendChild(this.grid, image.img);
                // unhide image
                this.renderer.setStyle(image.img, 'display', 'block');
                this.msnry.appended(image.img);
                this.msnry.reloadItems();
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    getImageClass() {
        /** @type {?} */
        let className = this.mansonryItemSelectorClass;
        if (this.imageClasses && this.imageClasses.length > 0) {
            /** @type {?} */
            const customClass = this.imageClasses.join(' ');
            className += ' ' + customClass;
        }
        return className;
    }
    /**
     * @private
     * @return {?}
     */
    getImageId() {
        return this.galleryGuid + '_' + utilities.newGuid();
    }
}
MasonryGalleryComponent.decorators = [
    { type: Component, args: [{
                changeDetection: ChangeDetectionStrategy.OnPush,
                selector: 'ngx-masonry-gallery',
                template: '<div [id]="galleryGuid"></div>'
            }] }
];
/** @nocollapse */
MasonryGalleryComponent.ctorParameters = () => [
    { type: Renderer2 }
];
MasonryGalleryComponent.propDecorators = {
    images: [{ type: Input }],
    width: [{ type: Input }],
    gutter: [{ type: Input }],
    verticalGutter: [{ type: Input }],
    imageClasses: [{ type: Input }],
    clickImage: [{ type: Output }],
    removeComplete: [{ type: Output }],
    layoutComplete: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    MasonryGalleryComponent.prototype.images;
    /** @type {?} */
    MasonryGalleryComponent.prototype.width;
    /** @type {?} */
    MasonryGalleryComponent.prototype.gutter;
    /** @type {?} */
    MasonryGalleryComponent.prototype.verticalGutter;
    /** @type {?} */
    MasonryGalleryComponent.prototype.imageClasses;
    /** @type {?} */
    MasonryGalleryComponent.prototype.clickImage;
    /** @type {?} */
    MasonryGalleryComponent.prototype.removeComplete;
    /** @type {?} */
    MasonryGalleryComponent.prototype.layoutComplete;
    /** @type {?} */
    MasonryGalleryComponent.prototype.galleryGuid;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.mansonryItemSelectorClass;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.activeImages;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.msnry;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.grid;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.changesToProcess;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.viewReady;
    /**
     * @type {?}
     * @private
     */
    MasonryGalleryComponent.prototype.renderer;
}
/**
 * @record
 */
function ActiveImage() { }
if (false) {
    /** @type {?} */
    ActiveImage.prototype.id;
    /** @type {?} */
    ActiveImage.prototype.image;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFzb25yeS1nYWxsZXJ5LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1tYXNvbnJ5LWdhbGxlcnkvIiwic291cmNlcyI6WyJsaWIvbWFzb25yeS1nYWxsZXJ5LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUVILFNBQVMsRUFDVCxZQUFZLEVBQ1osS0FBSyxFQUdMLE1BQU0sRUFDTixTQUFTLEVBRVQsdUJBQXVCLEdBQzFCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sa0JBQWtCLE1BQU0sY0FBYyxDQUFDO0FBQzlDLE9BQU8sS0FBSyxPQUFPLE1BQU0sZ0JBQWdCLENBQUM7QUFHMUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQU94QyxNQUFNLE9BQU8sdUJBQXVCOzs7O0lBc0JoQyxZQUFvQixRQUFtQjtRQUFuQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBcEI5QixXQUFNLEdBQTJCLEVBQUUsQ0FBQztRQUNwQyxVQUFLLEdBQVcsR0FBRyxDQUFDO1FBQ3BCLFdBQU0sR0FBVyxDQUFDLENBQUM7UUFDbkIsbUJBQWMsR0FBVyxDQUFDLENBQUM7UUFDM0IsaUJBQVksR0FBYSxFQUFFLENBQUM7UUFFM0IsZUFBVSxHQUFHLElBQUksWUFBWSxFQUF3QixDQUFDO1FBQ3RELG1CQUFjLEdBQUcsSUFBSSxZQUFZLEVBQVMsQ0FBQztRQUMzQyxtQkFBYyxHQUFHLElBQUksWUFBWSxFQUFTLENBQUM7UUFFckMsZ0JBQVcsR0FBVyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFekMsOEJBQXlCLEdBQUcsYUFBYSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDNUQsaUJBQVksR0FBa0IsRUFBRSxDQUFDO1FBSzFDLGNBQVMsR0FBWSxLQUFLLENBQUM7SUFFUSxDQUFDOzs7OztJQUU1QyxXQUFXLENBQUMsT0FBc0I7UUFDOUIsSUFBSSxPQUFPLENBQUMsTUFBTSxJQUFJLE9B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SSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7O2tCQUM3QyxXQUFXLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBRS9DLFNBQVMsSUFBSSxHQUFHLEdBQUcsV0FBVyxDQUFDO1NBQ2xDO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQzs7Ozs7SUFFTyxVQUFVO1FBQ2QsT0FBTyxJQUFJLENBQUMsV0FBVyxHQUFHLEdBQUcsR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDeEQsQ0FBQzs7O1lBalNKLFNBQVMsU0FBQztnQkFDUCxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtnQkFDL0MsUUFBUSxFQUFFLHFCQUFxQjtnQkFDL0IsUUFBUSxFQUFFLGdDQUFnQzthQUM3Qzs7OztZQWRHLFNBQVM7OztxQkFpQlIsS0FBSztvQkFDTCxLQUFLO3FCQUNMLEtBQUs7NkJBQ0wsS0FBSzsyQkFDTCxLQUFLO3lCQUVMLE1BQU07NkJBQ04sTUFBTTs2QkFDTixNQUFNOzs7O0lBUlAseUNBQTZDOztJQUM3Qyx3Q0FBNkI7O0lBQzdCLHlDQUE0Qjs7SUFDNUIsaURBQW9DOztJQUNwQywrQ0FBcUM7O0lBRXJDLDZDQUFnRTs7SUFDaEUsaURBQXFEOztJQUNyRCxpREFBcUQ7O0lBRXJELDhDQUEwRDs7Ozs7SUFFMUQsNERBQTZFOzs7OztJQUM3RSwrQ0FBa0Q7Ozs7O0lBRWxELHdDQUFvQjs7Ozs7SUFDcEIsdUNBQW1COzs7OztJQUNuQixtREFBeUM7Ozs7O0lBQ3pDLDRDQUFtQzs7Ozs7SUFFdkIsMkNBQTJCOzs7OztBQXlRM0MsMEJBR0M7OztJQUZHLHlCQUFXOztJQUNYLDRCQUE0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgICBBZnRlclZpZXdJbml0LFxyXG4gICAgQ29tcG9uZW50LFxyXG4gICAgRXZlbnRFbWl0dGVyLFxyXG4gICAgSW5wdXQsXHJcbiAgICBPbkNoYW5nZXMsXHJcbiAgICBPbkRlc3Ryb3ksXHJcbiAgICBPdXRwdXQsXHJcbiAgICBSZW5kZXJlcjIsXHJcbiAgICBTaW1wbGVDaGFuZ2VzLFxyXG4gICAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCBpbWFnZXNMb2FkZWRNZXRob2QgZnJvbSAnaW1hZ2VzbG9hZGVkJztcclxuaW1wb3J0ICogYXMgbWFzb25yeSBmcm9tICdtYXNvbnJ5LWxheW91dCc7XHJcblxyXG5pbXBvcnQgeyBJTWFzb25yeUdhbGxlcnlJbWFnZSB9IGZyb20gJy4vbWFzb25yeS1nYWxsZXJ5LW1vZGVscyc7XHJcbmltcG9ydCB7IHV0aWxpdGllcyB9IGZyb20gJy4vdXRpbGl0aWVzJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXHJcbiAgICBzZWxlY3RvcjogJ25neC1tYXNvbnJ5LWdhbGxlcnknLFxyXG4gICAgdGVtcGxhdGU6ICc8ZGl2IFtpZF09XCJnYWxsZXJ5R3VpZFwiPjwvZGl2PidcclxufSlcclxuZXhwb3J0IGNsYXNzIE1hc29ucnlHYWxsZXJ5Q29tcG9uZW50XHJcbiAgICBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcclxuICAgIEBJbnB1dCgpIGltYWdlczogSU1hc29ucnlHYWxsZXJ5SW1hZ2VbXSA9IFtdO1xyXG4gICAgQElucHV0KCkgd2lkdGg6IG51bWJlciA9IDMzMDtcclxuICAgIEBJbnB1dCgpIGd1dHRlcjogbnVtYmVyID0gNTtcclxuICAgIEBJbnB1dCgpIHZlcnRpY2FsR3V0dGVyOiBudW1iZXIgPSA1O1xyXG4gICAgQElucHV0KCkgaW1hZ2VDbGFzc2VzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIEBPdXRwdXQoKSBjbGlja0ltYWdlID0gbmV3IEV2ZW50RW1pdHRlcjxJTWFzb25yeUdhbGxlcnlJbWFnZT4oKTtcclxuICAgIEBPdXRwdXQoKSByZW1vdmVDb21wbGV0ZSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55W10+KCk7XHJcbiAgICBAT3V0cHV0KCkgbGF5b3V0Q29tcGxldGUgPSBuZXcgRXZlbnRFbWl0dGVyPGFueVtdPigpO1xyXG5cclxuICAgIHB1YmxpYyByZWFkb25seSBnYWxsZXJ5R3VpZDogc3RyaW5nID0gdXRpbGl0aWVzLm5ld0d1aWQoKTtcclxuXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1hbnNvbnJ5SXRlbVNlbGVjdG9yQ2xhc3MgPSBgZ3JpZC1pdGVtLSR7dGhpcy5nYWxsZXJ5R3VpZH1gO1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBhY3RpdmVJbWFnZXM6IEFjdGl2ZUltYWdlW10gPSBbXTtcclxuXHJcbiAgICBwcml2YXRlIG1zbnJ5PzogYW55O1xyXG4gICAgcHJpdmF0ZSBncmlkPzogYW55O1xyXG4gICAgcHJpdmF0ZSBjaGFuZ2VzVG9Qcm9jZXNzPzogU2ltcGxlQ2hhbmdlcztcclxuICAgIHByaXZhdGUgdmlld1JlYWR5OiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyKSB7IH1cclxuXHJcbiAgICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKGNoYW5nZXMuaW1hZ2VzICYmIGNoYW5nZXMuaW1hZ2VzLmN1cnJlbnRWYWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMudmlld1JlYWR5KSB7XHJcbiAgICAgICAgICAgICAgICAvLyBwcm9jZXNzIGltYWdlcyBvbmNlIHdlIGNhblxyXG4gICAgICAgICAgICAgICAgdGhpcy5jaGFuZ2VzVG9Qcm9jZXNzID0gY2hhbmdlcztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucHJvY2Vzc0ltYWdlcyhjaGFuZ2VzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5tc25yeSkge1xyXG4gICAgICAgICAgICB0aGlzLm1zbnJ5LmRlc3Ryb3koKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaGFuZGxlQ2xpY2soaW1hZ2U6IElNYXNvbnJ5R2FsbGVyeUltYWdlKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5jbGlja0ltYWdlLm5leHQoaW1hZ2UpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLnZpZXdSZWFkeSA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5pbml0TWFzb25yeSgpO1xyXG5cclxuICAgICAgICAvLyBwcm9jZXNzIGltYWdlcyBub3dcclxuICAgICAgICBpZiAodGhpcy5jaGFuZ2VzVG9Qcm9jZXNzKSB7XHJcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc0ltYWdlcyh0aGlzLmNoYW5nZXNUb1Byb2Nlc3MpO1xyXG4gICAgICAgICAgICB0aGlzLmNoYW5nZXNUb1Byb2Nlc3MgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFkZEltYWdlcyhpbWFnZXM6IElNYXNvbnJ5R2FsbGVyeUltYWdlW10pOiB2b2lkIHtcclxuICAgICAgICBpZiAoaW1hZ2VzICYmIGltYWdlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkSW1hZ2VzVG9HYWxsZXJ5KGltYWdlcyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUltYWdlcyhpbWFnZXM6IElNYXNvbnJ5R2FsbGVyeUltYWdlW10pOiB2b2lkIHtcclxuICAgICAgICBpZiAoaW1hZ2VzICYmIGltYWdlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGltYWdlcy5mb3JFYWNoKGltYWdlID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlSW1hZ2VGcm9tR2FsbGVyeShpbWFnZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHByb2Nlc3NJbWFnZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGltYWdlc1RvUHJvY2VzcyA9IHRoaXMuZ2V0QWRkZWRBbmRSZW1vdmVzSW1hZ2VzKGNoYW5nZXMpO1xyXG5cclxuICAgICAgICAvLyBhZGQgaW1hZ2VzIHRvIG1hbnNvbnJ5IGxheW91dFxyXG4gICAgICAgIHRoaXMuYWRkSW1hZ2VzKGltYWdlc1RvUHJvY2Vzcy5hZGRlZEltYWdlcyk7XHJcblxyXG4gICAgICAgIC8vIHJlbW92ZXMgaW1hZ2VzIGZyb20gbGF5b3V0XHJcbiAgICAgICAgdGhpcy5yZW1vdmVJbWFnZXMoaW1hZ2VzVG9Qcm9jZXNzLnJlbW92ZWRJbWFnZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0QWRkZWRBbmRSZW1vdmVzSW1hZ2VzKFxyXG4gICAgICAgIGNoYW5nZXM6IFNpbXBsZUNoYW5nZXNcclxuICAgICk6IHtcclxuICAgICAgICAgICAgYWRkZWRJbWFnZXM6IElNYXNvbnJ5R2FsbGVyeUltYWdlW107XHJcbiAgICAgICAgICAgIHJlbW92ZWRJbWFnZXM6IElNYXNvbnJ5R2FsbGVyeUltYWdlW107XHJcbiAgICAgICAgfSB7XHJcbiAgICAgICAgbGV0IGFkZGVkSW1hZ2VzOiBJTWFzb25yeUdhbGxlcnlJbWFnZVtdID0gW107XHJcbiAgICAgICAgY29uc3QgcmVtb3ZlZEltYWdlczogSU1hc29ucnlHYWxsZXJ5SW1hZ2VbXSA9IFtdO1xyXG5cclxuICAgICAgICBjb25zdCBuZXdJbWFnZXNWYWx1ZSA9IGNoYW5nZXMuaW1hZ2VzXHJcbiAgICAgICAgICAgIC5jdXJyZW50VmFsdWUgYXMgSU1hc29ucnlHYWxsZXJ5SW1hZ2VbXTtcclxuICAgICAgICBjb25zdCBvbGRJbWFnZXNWYWx1ZSA9IGNoYW5nZXMuaW1hZ2VzXHJcbiAgICAgICAgICAgIC5wcmV2aW91c1ZhbHVlIGFzIElNYXNvbnJ5R2FsbGVyeUltYWdlW107XHJcblxyXG4gICAgICAgIGlmICghb2xkSW1hZ2VzVmFsdWUpIHtcclxuICAgICAgICAgICAgLy8gYWxsIGltYWdlcyBhcmUgbmV3IG9uZXNcclxuICAgICAgICAgICAgYWRkZWRJbWFnZXMgPSBjaGFuZ2VzLmltYWdlcy5jdXJyZW50VmFsdWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gcHJvY2VzcyBhZGRlZCBpbWFnZXNcclxuICAgICAgICAgICAgbmV3SW1hZ2VzVmFsdWUuZm9yRWFjaChuZXdJbWFnZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ0ltYWdlID0gb2xkSW1hZ2VzVmFsdWUuZmluZChcclxuICAgICAgICAgICAgICAgICAgICBtID0+IG0uaW1hZ2VVcmwudG9Mb3dlckNhc2UoKSA9PT0gbmV3SW1hZ2UuaW1hZ2VVcmwudG9Mb3dlckNhc2UoKVxyXG4gICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdJbWFnZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGltYWdlIHdhcyBpbiBwcmV2aW91cyB2YWx1ZSAmJiBpcyBpbiBuZXcsIGRvIG5vdGhpbmdcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaW1hZ2UgaXMgbmV3XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkZWRJbWFnZXMucHVzaChuZXdJbWFnZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8gcHJvY2VzcyByZW1vdmVkIGltYWdlc1xyXG4gICAgICAgICAgICBvbGRJbWFnZXNWYWx1ZS5mb3JFYWNoKG9sZEltYWdlID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nSW1hZ2UgPSBuZXdJbWFnZXNWYWx1ZS5maW5kKFxyXG4gICAgICAgICAgICAgICAgICAgIG0gPT4gbS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpID09PSBvbGRJbWFnZS5pbWFnZVVybC50b0xvd2VyQ2FzZSgpXHJcbiAgICAgICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ0ltYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaW1hZ2Ugd2FzIGluIHByZXZpb3VzIHZhbHVlICYmIGlzIGluIG5ldywgZG8gbm90aGluZ1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBpbWFnZSBpcyByZW1vdmVkXHJcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlZEltYWdlcy5wdXNoKG9sZEltYWdlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBhZGRlZEltYWdlczogYWRkZWRJbWFnZXMsXHJcbiAgICAgICAgICAgIHJlbW92ZWRJbWFnZXM6IHJlbW92ZWRJbWFnZXNcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5pdE1hc29ucnkoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5ncmlkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5nYWxsZXJ5R3VpZCk7XHJcblxyXG4gICAgICAgIC8vIHJlbW92ZSBhbGwgZXhpc3RpbmcgZGF0YSBmcm9tIGdyaWRcclxuICAgICAgICB0aGlzLmdyaWQuaW5uZXJIVE1MID0gJyc7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5ncmlkKSB7XHJcbiAgICAgICAgICAgIHRocm93IEVycm9yKFxyXG4gICAgICAgICAgICAgICAgYENvdWxkIG5vdCBpbml0IG1hbnNvcnkgZHVlIHRvIG5vbiBleGlzdGluZyBlbGVtIHdpdGggaWQgJyR7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmdhbGxlcnlHdWlkXHJcbiAgICAgICAgICAgICAgICB9J2BcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMubXNucnkgPSBuZXcgbWFzb25yeSh0aGlzLmdyaWQsIHtcclxuICAgICAgICAgICAgLy8gb3B0aW9ucy4uLlxyXG4gICAgICAgICAgICBpdGVtU2VsZWN0b3I6ICcuJyArIHRoaXMubWFuc29ucnlJdGVtU2VsZWN0b3JDbGFzcyxcclxuICAgICAgICAgICAgY29sdW1uV2lkdGg6IHRoaXMud2lkdGgsXHJcbiAgICAgICAgICAgIGd1dHRlcjogdGhpcy5ndXR0ZXIsXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xyXG5cclxuICAgICAgICB0aGlzLm1zbnJ5Lm9uKCdsYXlvdXRDb21wbGV0ZScsIGZ1bmN0aW9uIChpdGVtcykge1xyXG4gICAgICAgICAgICB0aGF0LmxheW91dENvbXBsZXRlLm5leHQoaXRlbXMpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLm1zbnJ5Lm9uKCdyZW1vdmVDb21wbGV0ZScsIGZ1bmN0aW9uIChpdGVtcykge1xyXG4gICAgICAgICAgICB0aGF0LnJlbW92ZUNvbXBsZXRlLm5leHQoaXRlbXMpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVtb3ZlSW1hZ2VGcm9tR2FsbGVyeShpbWFnZTogSU1hc29ucnlHYWxsZXJ5SW1hZ2UpOiB2b2lkIHtcclxuICAgICAgICAvLyBnZXQgaW1hZ2UgZ3VpZFxyXG4gICAgICAgIGNvbnN0IGltYWdlSWRSZXN1bHQgPSB0aGlzLmFjdGl2ZUltYWdlcy5maW5kKFxyXG4gICAgICAgICAgICBtID0+IG0uaW1hZ2UuaW1hZ2VVcmwudG9Mb3dlckNhc2UoKSA9PT0gaW1hZ2UuaW1hZ2VVcmwudG9Mb3dlckNhc2UoKVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIGlmICghaW1hZ2VJZFJlc3VsdCkge1xyXG4gICAgICAgICAgICAvLyBpbWFnZSB3YXMgbm90IGZvdW5kLCB0aGlzIGlzIHByb2JhYmx5IGFuIGVycm9yXHJcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcclxuICAgICAgICAgICAgICAgIGBJbWFnZSB3aXRoIHVybCAnJHtcclxuICAgICAgICAgICAgICAgIGltYWdlLmltYWdlVXJsXHJcbiAgICAgICAgICAgICAgICB9JyB3YXMgbm90IGZvdW5kLiBJZiB5b3UgYXJlIGFkZGluZyBpbWFnZXMsIG1ha2Ugc3VyZSB0byAncmVwbGFjZScgdGhlIGltYWdlcyBhcnJheSB3aXRoIGEgbmV3IG9uZVxyXG4gICAgICAgICAgICAgICAgc28gdGhhdCBkZXRlY3Rpb24gY2hhbmdlIGNhbiBiZSBleGVjdXRlZCBpbnN0ZWFkIG9mIGp1c3QgYWRkaW5nIGFuIGltYWdlIHRvIGFycmF5XHJcbiAgICAgICAgICAgICAgICAod2hpY2ggZG9lc24ndCBmaXJlIGNoYW5nZSBkZXRlY3Rpb24gb24gYXJyYXkgcHJvcGVydHkpYFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBmaW5kIGltYWdlIGJhc2VkIG9uIGl0cyBpZFxyXG4gICAgICAgIGNvbnN0IGltYWdlRWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGltYWdlSWRSZXN1bHQuaWQpO1xyXG5cclxuICAgICAgICBpZiAoIWltYWdlRWxlbSkge1xyXG4gICAgICAgICAgICAvLyBpbWFnZSB3YXMgbm90IGZvdW5kIGluIERPTVxyXG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXHJcbiAgICAgICAgICAgICAgICBgSW1hZ2Ugd2l0aCBpZCAneyR7XHJcbiAgICAgICAgICAgICAgICBpbWFnZUlkUmVzdWx0LmlkXHJcbiAgICAgICAgICAgICAgICB9fScgd2FzIG5vdCBmb3VuZCBpbiBET00uIEhhdmUgeW91IG1hbmlwdWxhdGVkIHRoZSBET00gaW4gc29tZSB3YXk/YFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyByZW1vdmUgaW1hZ2UgZnJvbSBnYWxsZXJ5XHJcbiAgICAgICAgdGhpcy5tc25yeS5yZW1vdmUoaW1hZ2VFbGVtKTtcclxuXHJcbiAgICAgICAgLy8gcmVmcmVzaCBsYXlvdXRcclxuICAgICAgICB0aGlzLm1zbnJ5LmxheW91dCgpO1xyXG5cclxuICAgICAgICAvLyByZW1vdmUgaW1hZ2UgZnJvbSBhcnJheVxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5hY3RpdmVJbWFnZXMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgY29uc3QgaWRXaXRoSW1hZ2UgPSB0aGlzLmFjdGl2ZUltYWdlc1tpXTtcclxuICAgICAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICAgICAgaWRXaXRoSW1hZ2UuaW1hZ2UuaW1hZ2VVcmwudG9Mb3dlckNhc2UoKSA9PT1cclxuICAgICAgICAgICAgICAgIGltYWdlSWRSZXN1bHQuaW1hZ2UuaW1hZ2VVcmwudG9Mb3dlckNhc2UoKVxyXG4gICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlSW1hZ2VzLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGFkZEltYWdlc1RvR2FsbGVyeShpbWFnZXM6IElNYXNvbnJ5R2FsbGVyeUltYWdlW10pOiB2b2lkIHtcclxuICAgICAgICBpZiAoIXRoaXMuZ3JpZCkge1xyXG4gICAgICAgICAgICB0aHJvdyBFcnJvcihcclxuICAgICAgICAgICAgICAgICdHcmlkIGVsZW1lbnQgaXMgbm90IHlldCByZWFkeSwgYXJlIHlvdSB0cnlpbmcgdG8gYWRkIGltYWdlIHRvbyBzb29uPydcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGltYWdlc1dyYXBwZXIgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuXHJcbiAgICAgICAgaW1hZ2VzLmZvckVhY2goaW1hZ2UgPT4ge1xyXG4gICAgICAgICAgICAvLyBnZW5lcmF0ZSB1bmlxdWUgaW1hZ2UgaWRcclxuICAgICAgICAgICAgY29uc3QgaW1hZ2VJZCA9IHRoaXMuZ2V0SW1hZ2VJZCgpO1xyXG5cclxuICAgICAgICAgICAgLy8gY3JlYXRlIGVsZW1lbnRcclxuICAgICAgICAgICAgY29uc3QgaW1hZ2VFbGVtID0gdGhpcy5yZW5kZXJlci5jcmVhdGVFbGVtZW50KCdpbWcnKTtcclxuICAgICAgICAgICAgaW1hZ2VFbGVtLnNldEF0dHJpYnV0ZSgnaWQnLCBpbWFnZUlkKTtcclxuICAgICAgICAgICAgaW1hZ2VFbGVtLnNldEF0dHJpYnV0ZSgnYWx0JywgaW1hZ2UuYWx0ID8gaW1hZ2UuYWx0IDogJ25vIGRlc2NyaXB0aW9uJyk7XHJcbiAgICAgICAgICAgIGltYWdlRWxlbS5zZXRBdHRyaWJ1dGUoJ3NyYycsIGltYWdlLmltYWdlVXJsKTtcclxuICAgICAgICAgICAgLy8gbm90ZSAtIGltYWdlcyBhcmUgaGlkZGVuIGJ5IGRlZmF1bHQgYW5kIHNob3VsZCBiZSBzaG93biBvbmx5IGFmdGVyIHRoZXkgYXJlIGxvYWRlZFxyXG4gICAgICAgICAgICBpbWFnZUVsZW0uc2V0QXR0cmlidXRlKFxyXG4gICAgICAgICAgICAgICAgJ3N0eWxlJyxcclxuICAgICAgICAgICAgICAgIGBkaXNwbGF5OiBub25lOyB3aWR0aDogJHt0aGlzLndpZHRofXB4OyBtYXJnaW4tYm90dG9tOiAke1xyXG4gICAgICAgICAgICAgICAgdGhpcy52ZXJ0aWNhbEd1dHRlclxyXG4gICAgICAgICAgICAgICAgfXB4YFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBpbWFnZUVsZW0uY2xhc3NOYW1lID0gdGhpcy5nZXRJbWFnZUNsYXNzKCk7XHJcbiAgICAgICAgICAgIGltYWdlRWxlbS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlQ2xpY2soaW1hZ2UpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIHN0b3JlIGd1aWQgd2l0aCB0aGlzIGltYWdlXHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlSW1hZ2VzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgaWQ6IGltYWdlSWQsXHJcbiAgICAgICAgICAgICAgICBpbWFnZTogaW1hZ2VcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyBhZGQgdG8gZG9tIGFuZCBtYW5zb3J5ICYgcmVmcmVzaCBsYXlvdXRcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZChpbWFnZXNXcmFwcGVyLCBpbWFnZUVsZW0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBhZGQgaHRtbCB0byBkb21cclxuICAgICAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHRoaXMuZ3JpZCwgaW1hZ2VzV3JhcHBlcik7XHJcblxyXG4gICAgICAgIC8vIGFkZCBpbWFnZXMgb25jZSB0aGV5IGFyZSBsb2FkZWRcclxuICAgICAgICBjb25zdCBpbWdMb2FkID0gaW1hZ2VzTG9hZGVkTWV0aG9kKGltYWdlc1dyYXBwZXIpO1xyXG4gICAgICAgIGltZ0xvYWQub24oJ3Byb2dyZXNzJywgKGluc3RhbmNlLCBpbWFnZSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoaW1hZ2UuaXNMb2FkZWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy5ncmlkLCBpbWFnZS5pbWcpO1xyXG4gICAgICAgICAgICAgICAgLy8gdW5oaWRlIGltYWdlXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNldFN0eWxlKGltYWdlLmltZywgJ2Rpc3BsYXknLCAnYmxvY2snKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubXNucnkuYXBwZW5kZWQoaW1hZ2UuaW1nKTtcclxuICAgICAgICAgICAgICAgIHRoaXMubXNucnkucmVsb2FkSXRlbXMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0SW1hZ2VDbGFzcygpOiBzdHJpbmcge1xyXG4gICAgICAgIGxldCBjbGFzc05hbWUgPSB0aGlzLm1hbnNvbnJ5SXRlbVNlbGVjdG9yQ2xhc3M7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmltYWdlQ2xhc3NlcyAmJiB0aGlzLmltYWdlQ2xhc3Nlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1c3RvbUNsYXNzID0gdGhpcy5pbWFnZUNsYXNzZXMuam9pbignICcpO1xyXG5cclxuICAgICAgICAgICAgY2xhc3NOYW1lICs9ICcgJyArIGN1c3RvbUNsYXNzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGNsYXNzTmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEltYWdlSWQoKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nYWxsZXJ5R3VpZCArICdfJyArIHV0aWxpdGllcy5uZXdHdWlkKCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmludGVyZmFjZSBBY3RpdmVJbWFnZSB7XHJcbiAgICBpZDogc3RyaW5nO1xyXG4gICAgaW1hZ2U6IElNYXNvbnJ5R2FsbGVyeUltYWdlO1xyXG59XHJcbiJdfQ==